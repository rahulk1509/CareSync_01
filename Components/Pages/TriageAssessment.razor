@page "/triage"
@page "/triage/{PatientId:int}"
@inject IPatientService PatientService
@inject ITriageService TriageService
@inject NavigationManager Navigation

<div class="triage-page">
    <div class="page-header">
        <h1>AI Triage Assessment</h1>
        <p>Intelligent risk analysis powered by machine learning</p>
    </div>

    @if (_loading)
    {
        <div class="loading-card card">
            <div class="card-body text-center">
                <div class="spinner-lg"></div>
                <p>Loading patient data...</p>
            </div>
        </div>
    }
    else if (_patient == null)
    {
        <div class="card">
            <div class="card-body text-center">
                <h3>No Patient Selected</h3>
                <p>Register a patient or select an existing one to begin the AI triage assessment.</p>
                <a href="/intake" class="btn btn-primary">Register New Patient</a>
            </div>
        </div>
    }
    else
    {
        <!-- Patient Info -->
        <div class="patient-banner">
            <div class="patient-avatar">@_patient.FirstName[0]@_patient.LastName[0]</div>
            <div class="patient-info">
                <h3>@_patient.FullName</h3>
                <p>@_patient.Age years old | DOB: @_patient.DateOfBirth.ToString("MMM dd, yyyy")</p>
            </div>
        </div>
        
        <div class="card complaint-card">
            <div class="card-header">Chief Complaint</div>
            <div class="card-body">
                <p>@_patient.ChiefComplaint</p>
            </div>
        </div>

        @if (_prediction != null)
        {
            <!-- Results -->
            <div class="result-container">
                <div class="result-main card @GetResultClass()">
                    <div class="result-header">
                        <div class="result-score">
                            <span class="score-value">@((_prediction.RiskScore * 100).ToString("F0"))%</span>
                            <span class="score-label">Risk Score</span>
                        </div>
                        <div class="result-level">
                            <span class="level-badge">@_prediction.GetLevelText()</span>
                        </div>
                    </div>
                    <div class="result-body">
                        <p class="recommendation">@_prediction.Recommendation</p>
                        
                        <div class="factors-section">
                            <h4>Risk Factors Identified:</h4>
                            <ul>
                                @foreach (var factor in _prediction.RiskFactors)
                                {
                                    <li>@factor</li>
                                }
                            </ul>
                        </div>
                        
                        <div class="confidence-section">
                            <span>AI Confidence:</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: @((_prediction.Confidence * 100))%"></div>
                            </div>
                            <span>@((_prediction.Confidence * 100).ToString("F0"))%</span>
                        </div>
                    </div>
                </div>
                
                <div class="result-actions">
                    <button class="btn btn-outline" @onclick="ResetAssessment">New Assessment</button>
                    <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/"))">Return Home</button>
                </div>
            </div>
        }
        else
        {
            <!-- Assessment Form -->
            <EditForm Model="@_assessment" OnValidSubmit="PerformAssessment">
                
                <!-- Vital Signs -->
                <div class="card form-card">
                    <div class="card-header">Vital Signs</div>
                    <div class="card-body">
                        <div class="vitals-grid">
                            <div class="vital-item">
                                <label>Heart Rate (bpm)</label>
                                <InputNumber @bind-Value="_assessment.HeartRate" class="form-input" />
                                <small>Normal: 60-100</small>
                            </div>
                            <div class="vital-item">
                                <label>BP Systolic (mmHg)</label>
                                <InputNumber @bind-Value="_assessment.BloodPressureSystolic" class="form-input" />
                                <small>Normal: 90-120</small>
                            </div>
                            <div class="vital-item">
                                <label>BP Diastolic (mmHg)</label>
                                <InputNumber @bind-Value="_assessment.BloodPressureDiastolic" class="form-input" />
                                <small>Normal: 60-80</small>
                            </div>
                            <div class="vital-item">
                                <label>Temperature (C)</label>
                                <InputNumber @bind-Value="_assessment.Temperature" class="form-input" />
                                <small>Normal: 36.1-37.2</small>
                            </div>
                            <div class="vital-item">
                                <label>Respiratory Rate (/min)</label>
                                <InputNumber @bind-Value="_assessment.RespiratoryRate" class="form-input" />
                                <small>Normal: 12-20</small>
                            </div>
                            <div class="vital-item">
                                <label>O2 Saturation (%)</label>
                                <InputNumber @bind-Value="_assessment.OxygenSaturation" class="form-input" />
                                <small>Normal: 95-100</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pain Level -->
                <div class="card form-card">
                    <div class="card-header">Pain Level: @_assessment.PainLevel/10</div>
                    <div class="card-body">
                        <input type="range" min="0" max="10" @bind="_assessment.PainLevel" @bind:event="oninput" class="pain-slider" />
                        <div class="pain-labels">
                            <span>0 - No Pain</span>
                            <span>5 - Moderate</span>
                            <span>10 - Severe</span>
                        </div>
                    </div>
                </div>

                <!-- Symptoms -->
                <div class="card form-card">
                    <div class="card-header">Symptoms Assessment</div>
                    <div class="card-body">
                        <div class="symptoms-grid">
                            <div class="symptom-item">
                                <label>Chest Pain</label>
                                <InputSelect @bind-Value="_assessment.ChestPain" class="form-input">
                                    @foreach (var s in Enum.GetValues<SymptomSeverity>())
                                    {
                                        <option value="@s">@s</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="symptom-item">
                                <label>Shortness of Breath</label>
                                <InputSelect @bind-Value="_assessment.ShortnessOfBreath" class="form-input">
                                    @foreach (var s in Enum.GetValues<SymptomSeverity>())
                                    {
                                        <option value="@s">@s</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="symptom-item">
                                <label>Altered Consciousness</label>
                                <InputSelect @bind-Value="_assessment.AlteredConsciousness" class="form-input">
                                    @foreach (var s in Enum.GetValues<SymptomSeverity>())
                                    {
                                        <option value="@s">@s</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="symptom-item">
                                <label>Bleeding</label>
                                <InputSelect @bind-Value="_assessment.Bleeding" class="form-input">
                                    @foreach (var s in Enum.GetValues<SymptomSeverity>())
                                    {
                                        <option value="@s">@s</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="symptom-item">
                                <label>Fever</label>
                                <InputSelect @bind-Value="_assessment.Fever" class="form-input">
                                    @foreach (var s in Enum.GetValues<SymptomSeverity>())
                                    {
                                        <option value="@s">@s</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card form-card">
                    <div class="card-header">Additional Notes</div>
                    <div class="card-body">
                        <InputTextArea @bind-Value="_assessment.Notes" class="form-input" rows="3" 
                            placeholder="Enter any additional observations or clinical notes..." />
                    </div>
                </div>

                <!-- Submit -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-accent btn-lg" disabled="@_processing">
                        @if (_processing)
                        {
                            <span class="spinner"></span>
                            <span>Analyzing...</span>
                        }
                        else
                        {
                            <span>Run AI Triage Assessment</span>
                        }
                    </button>
                </div>
            </EditForm>
        }
    }
</div>

@code {
    [Parameter] public int? PatientId { get; set; }
    private Patient? _patient;
    private Models.TriageAssessment _assessment = new();
    private RiskPrediction? _prediction;
    private bool _loading = true;
    private bool _processing = false;

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _loading = true;
        if (PatientId.HasValue)
        {
            _patient = await PatientService.GetPatientAsync(PatientId.Value);
            if (_patient != null)
            {
                _assessment = new Models.TriageAssessment
                {
                    PatientId = _patient.Id,
                    HeartRate = 80,
                    BloodPressureSystolic = 120,
                    BloodPressureDiastolic = 80,
                    Temperature = 37.0f,
                    RespiratoryRate = 16,
                    OxygenSaturation = 98,
                    PainLevel = 3
                };
            }
        }
        _loading = false;
    }

    private async Task PerformAssessment()
    {
        if (_patient == null) return;
        _processing = true;
        try { _prediction = await TriageService.AssessPatientAsync(_patient, _assessment); }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally { _processing = false; }
    }

    private void ResetAssessment()
    {
        _prediction = null;
        _assessment = new Models.TriageAssessment
        {
            PatientId = _patient?.Id ?? 0,
            HeartRate = 80, BloodPressureSystolic = 120, BloodPressureDiastolic = 80,
            Temperature = 37.0f, RespiratoryRate = 16, OxygenSaturation = 98, PainLevel = 3
        };
    }

    private string GetResultClass() => _prediction?.PredictedLevel switch
    {
        TriageLevel.Emergency => "result-emergency",
        TriageLevel.Urgent => "result-urgent",
        TriageLevel.Standard => "result-standard",
        _ => "result-low"
    };
}

<style>
    .triage-page { max-width: 800px; margin: 0 auto; }
    
    .page-header { margin-bottom: var(--space-6); }
    .page-header h1 { margin-bottom: var(--space-2); }
    .page-header p { color: var(--gray-500); margin: 0; }

    /* Loading */
    .spinner-lg {
        width: 40px; height: 40px;
        border: 3px solid var(--gray-200);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto var(--space-4);
    }

    /* Patient Banner */
    .patient-banner {
        display: flex;
        align-items: center;
        gap: var(--space-4);
        background: var(--primary-bg);
        border: 2px solid var(--primary);
        border-radius: var(--radius-lg);
        padding: var(--space-4) var(--space-6);
        margin-bottom: var(--space-4);
    }

    .patient-avatar {
        width: 56px; height: 56px;
        background: var(--primary);
        color: var(--white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
    }

    .patient-info h3 { margin: 0; font-size: 1.25rem; }
    .patient-info p { margin: var(--space-1) 0 0; color: var(--gray-600); font-size: 0.875rem; }

    .complaint-card { margin-bottom: var(--space-6); }
    .complaint-card p { margin: 0; }

    /* Form Cards */
    .form-card { margin-bottom: var(--space-6); }

    .vitals-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-4);
    }

    .vital-item label {
        display: block;
        font-weight: 500;
        margin-bottom: var(--space-2);
        font-size: 0.875rem;
    }

    .vital-item small {
        display: block;
        color: var(--gray-400);
        font-size: 0.75rem;
        margin-top: var(--space-1);
    }

    /* Pain Slider */
    .pain-slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        appearance: none;
        background: linear-gradient(to right, var(--success), var(--warning), var(--danger));
        cursor: pointer;
        margin: var(--space-4) 0;
    }

    .pain-slider::-webkit-slider-thumb {
        appearance: none;
        width: 24px; height: 24px;
        background: var(--white);
        border: 2px solid var(--gray-400);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: var(--shadow-md);
    }

    .pain-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    /* Symptoms */
    .symptoms-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-4);
    }

    .symptom-item label {
        display: block;
        font-weight: 500;
        margin-bottom: var(--space-2);
        font-size: 0.875rem;
    }

    .form-actions {
        text-align: center;
        padding-top: var(--space-4);
    }

    .btn-lg {
        padding: var(--space-4) var(--space-8);
        font-size: 1rem;
    }

    /* Results */
    .result-container { margin-top: var(--space-6); }

    .result-main {
        border-width: 3px;
        margin-bottom: var(--space-6);
    }

    .result-emergency { border-color: var(--danger); }
    .result-urgent { border-color: var(--warning); }
    .result-standard { border-color: var(--primary); }
    .result-low { border-color: var(--success); }

    .result-emergency .card-header { background: var(--danger); }
    .result-urgent .card-header { background: var(--warning); }
    .result-standard .card-header { background: var(--primary); }
    .result-low .card-header { background: var(--success); }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-6);
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
    }

    .score-value {
        display: block;
        font-size: 3rem;
        font-weight: 700;
        color: var(--gray-900);
        line-height: 1;
    }

    .score-label {
        font-size: 0.75rem;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .level-badge {
        background: var(--gray-800);
        color: var(--white);
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-full);
        font-weight: 600;
    }

    .result-body { padding: var(--space-6); }

    .recommendation {
        font-size: 1.125rem;
        color: var(--gray-700);
        line-height: 1.6;
        margin-bottom: var(--space-6);
        padding: var(--space-4);
        background: var(--gray-50);
        border-radius: var(--radius-md);
    }

    .factors-section { margin-bottom: var(--space-6); }
    .factors-section h4 { margin-bottom: var(--space-3); }
    .factors-section ul { margin: 0; padding-left: var(--space-6); }
    .factors-section li { margin-bottom: var(--space-2); color: var(--gray-600); }

    .confidence-section {
        display: flex;
        align-items: center;
        gap: var(--space-4);
        padding-top: var(--space-4);
        border-top: 1px solid var(--gray-200);
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    .confidence-bar {
        flex: 1;
        height: 8px;
        background: var(--gray-200);
        border-radius: 4px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 4px;
    }

    .result-actions {
        display: flex;
        justify-content: center;
        gap: var(--space-4);
    }

    @@media (max-width: 768px) {
        .vitals-grid { grid-template-columns: repeat(2, 1fr); }
        .symptoms-grid { grid-template-columns: 1fr; }
    }

    @@media (max-width: 480px) {
        .vitals-grid { grid-template-columns: 1fr; }
        .result-actions { flex-direction: column; }
        .result-actions .btn { width: 100%; }
    }
</style>
