@page "/ai-model"
@inject NavigationManager Navigation
@inject HospitalTriageAI.Services.IAuthService AuthService
@inject HospitalTriageAI.Services.IModelTrainingService ModelTrainingService

<div class="ai-model-page">
    @if (!AuthService.IsAdmin)
    {
        <div class="access-denied">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <h2>Access Denied</h2>
            <p>Admin authentication required to access AI Model Management.</p>
            <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/admin"))">
                Go to Admin Login
            </button>
        </div>
    }
    else
    {
        <div class="page-header">
            <div class="header-content">
                <h1>AI Model Management</h1>
                <p>Train, manage, and monitor the triage prediction model</p>
            </div>
        </div>

        <!-- Model Status Card -->
        <div class="model-status-card">
            <div class="status-header">
                <div class="status-icon @(_modelInfo.IsLoaded ? "active" : "inactive")">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <div class="status-info">
                    <h3>Model Status</h3>
                    <span class="status-badge @(_modelInfo.IsLoaded ? "badge-active" : "badge-warning")">
                        @(_modelInfo.IsLoaded ? "Trained & Ready" : "Not Trained")
                    </span>
                </div>
            </div>

            @if (_modelInfo.IsLoaded)
            {
                <div class="model-details">
                    <div class="detail-item">
                        <span class="detail-label">Trained On</span>
                        <span class="detail-value">@(_modelInfo.TrainedDate?.ToString("MMM dd, yyyy HH:mm") ?? "Unknown")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Training Records</span>
                        <span class="detail-value">@(_modelInfo.TrainingRecords?.ToString("N0") ?? "Unknown")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Model Location</span>
                        <span class="detail-value path">@_modelInfo.ModelPath</span>
                    </div>
                </div>
            }
            else
            {
                <div class="no-model-info">
                    <p>No trained model found. Train a model using CSV data to enable AI-powered triage predictions.</p>
                    <p class="hint">Until trained, the system uses rule-based predictions.</p>
                </div>
            }
        </div>

        <!-- Action Cards Grid -->
        <div class="action-grid">
            <!-- Train Model Card -->
            <div class="action-card">
                <div class="card-icon train">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="17 1 21 5 17 9"/>
                        <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                        <polyline points="7 23 3 19 7 15"/>
                        <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                    </svg>
                </div>
                <h3>Train New Model</h3>
                <p>Upload CSV data to train or retrain the AI triage model</p>
                <button class="btn btn-primary" @onclick="HandleTrainModel">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload CSV & Train
                </button>
            </div>

            <!-- Download Sample Card -->
            <div class="action-card">
                <div class="card-icon sample">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                </div>
                <h3>Sample CSV Format</h3>
                <p>Download a sample CSV file with the correct format</p>
                <button class="btn btn-outline" @onclick="DownloadSampleCsv">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download Sample
                </button>
            </div>

            <!-- Model Info Card -->
            <div class="action-card">
                <div class="card-icon info">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                </div>
                <h3>How It Works</h3>
                <p>Learn about the AI model and prediction algorithm</p>
                <button class="btn btn-outline" @onclick="@(() => _showInfoModal = true)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Learn More
                </button>
            </div>
        </div>

        <!-- CSV Format Info -->
        <div class="csv-info-section">
            <h3>CSV Data Format Requirements</h3>
            <div class="csv-table-container">
                <table class="csv-table">
                    <thead>
                        <tr>
                            <th>Column</th>
                            <th>Type</th>
                            <th>Example</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>Patient_ID</code></td>
                            <td>String</td>
                            <td>P001</td>
                            <td>Unique patient identifier</td>
                        </tr>
                        <tr>
                            <td><code>Age</code></td>
                            <td>Integer</td>
                            <td>45</td>
                            <td>Patient age in years</td>
                        </tr>
                        <tr>
                            <td><code>Gender</code></td>
                            <td>String</td>
                            <td>Male/Female</td>
                            <td>Patient gender</td>
                        </tr>
                        <tr>
                            <td><code>Symptoms</code></td>
                            <td>String</td>
                            <td>Chest pain, Fever</td>
                            <td>Comma-separated symptoms</td>
                        </tr>
                        <tr>
                            <td><code>Blood_Pressure</code></td>
                            <td>String</td>
                            <td>120/80</td>
                            <td>Systolic/Diastolic</td>
                        </tr>
                        <tr>
                            <td><code>Heart_Rate</code></td>
                            <td>Integer</td>
                            <td>72</td>
                            <td>Beats per minute</td>
                        </tr>
                        <tr>
                            <td><code>Temperature</code></td>
                            <td>Float</td>
                            <td>37.5</td>
                            <td>Body temperature (�C)</td>
                        </tr>
                        <tr>
                            <td><code>Pre_Existing_Conditions</code></td>
                            <td>String</td>
                            <td>Diabetes, Hypertension</td>
                            <td>Comma-separated conditions</td>
                        </tr>
                        <tr>
                            <td><code>Risk_Level</code></td>
                            <td>String</td>
                            <td>Low/Medium/High/Critical</td>
                            <td>Target triage level</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="format-note">
                <strong>Note:</strong> Both comma-separated (CSV) and tab-separated (TSV) formats are supported. 
                The system will auto-detect the format.
            </p>
        </div>

        <!-- Bias/Fairness Analysis Section -->
        <div class="bias-analysis-section">
            <div class="section-header">
                <div>
                    <h3>Bias & Fairness Analysis</h3>
                    <p>Analyze model predictions across demographic groups</p>
                </div>
                <button class="btn btn-outline" @onclick="OpenBiasAnalysisModal">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Analyze CSV Data
                </button>
            </div>

            @if (_biasAnalysis != null && _biasAnalysis.IsAvailable)
            {
                <div class="analysis-results">
                    <!-- Gender Accuracy Card -->
                    <div class="analysis-card">
                        <h4>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            Accuracy by Gender
                        </h4>
                        <div class="gender-metrics">
                            <div class="gender-item male">
                                <span class="gender-icon">♂</span>
                                <div class="gender-info">
                                    <span class="gender-label">Male</span>
                                    <span class="gender-value">@(_biasAnalysis.GenderAnalysis?.Male.Accuracy.ToString("F1"))%</span>
                                    <span class="sample-count">n=@(_biasAnalysis.GenderAnalysis?.Male.SampleCount)</span>
                                </div>
                                <div class="accuracy-bar-mini">
                                    <div class="accuracy-fill" style="width: @(_biasAnalysis.GenderAnalysis?.Male.Accuracy ?? 0)%"></div>
                                </div>
                            </div>
                            <div class="gender-item female">
                                <span class="gender-icon">♀</span>
                                <div class="gender-info">
                                    <span class="gender-label">Female</span>
                                    <span class="gender-value">@(_biasAnalysis.GenderAnalysis?.Female.Accuracy.ToString("F1"))%</span>
                                    <span class="sample-count">n=@(_biasAnalysis.GenderAnalysis?.Female.SampleCount)</span>
                                </div>
                                <div class="accuracy-bar-mini">
                                    <div class="accuracy-fill" style="width: @(_biasAnalysis.GenderAnalysis?.Female.Accuracy ?? 0)%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="disparity-info @((_biasAnalysis.GenderAnalysis?.AccuracyDisparity ?? 0) < 5 ? "low" : "high")">
                            <span>Disparity:</span>
                            <strong>@(_biasAnalysis.GenderAnalysis?.AccuracyDisparity.ToString("F1"))%</strong>
                            @if ((_biasAnalysis.GenderAnalysis?.AccuracyDisparity ?? 0) < 5)
                            {
                                <span class="status-badge good">Fair</span>
                            }
                            else
                            {
                                <span class="status-badge warning">Review Needed</span>
                            }
                        </div>
                    </div>

                    <!-- Age Group Distribution Card -->
                    <div class="analysis-card wide">
                        <h4>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <line x1="3" y1="9" x2="21" y2="9"/>
                                <line x1="9" y1="21" x2="9" y2="9"/>
                            </svg>
                            Risk Distribution by Age Group
                        </h4>
                        <div class="age-chart">
                            @foreach (var ageGroup in _biasAnalysis.AgeGroupAnalysis)
                            {
                                <div class="age-group-bar">
                                    <div class="bar-label">@ageGroup.AgeGroup</div>
                                    <div class="stacked-bar">
                                        <div class="bar-segment low" style="width: @ageGroup.LowRiskPercent%"
                                             title="Low: @ageGroup.LowRiskCount (@ageGroup.LowRiskPercent.ToString("F0")%)"></div>
                                        <div class="bar-segment medium" style="width: @ageGroup.MediumRiskPercent%"
                                             title="Medium: @ageGroup.MediumRiskCount (@ageGroup.MediumRiskPercent.ToString("F0")%)"></div>
                                        <div class="bar-segment high" style="width: @ageGroup.HighRiskPercent%"
                                             title="High: @ageGroup.HighRiskCount (@ageGroup.HighRiskPercent.ToString("F0")%)"></div>
                                        <div class="bar-segment critical" style="width: @ageGroup.CriticalRiskPercent%"
                                             title="Critical: @ageGroup.CriticalRiskCount (@ageGroup.CriticalRiskPercent.ToString("F0")%)"></div>
                                    </div>
                                    <div class="bar-count">n=@ageGroup.SampleCount</div>
                                </div>
                            }
                        </div>
                        <div class="chart-legend">
                            <span class="legend-item"><span class="dot low"></span>Low</span>
                            <span class="legend-item"><span class="dot medium"></span>Medium</span>
                            <span class="legend-item"><span class="dot high"></span>High</span>
                            <span class="legend-item"><span class="dot critical"></span>Critical</span>
                        </div>
                    </div>

                    <!-- False Positive/Negative Rates Card -->
                    <div class="analysis-card">
                        <h4>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            Error Rates by Gender
                        </h4>
                        <div class="error-rates-table">
                            <div class="error-row header">
                                <span>Metric</span>
                                <span>Male</span>
                                <span>Female</span>
                            </div>
                            <div class="error-row">
                                <span>False Positive Rate</span>
                                <span class="@((_biasAnalysis.GenderAnalysis?.Male.FalsePositiveRate ?? 0) > 15 ? "warning" : "")">
                                    @(_biasAnalysis.GenderAnalysis?.Male.FalsePositiveRate.ToString("F1"))%
                                </span>
                                <span class="@((_biasAnalysis.GenderAnalysis?.Female.FalsePositiveRate ?? 0) > 15 ? "warning" : "")">
                                    @(_biasAnalysis.GenderAnalysis?.Female.FalsePositiveRate.ToString("F1"))%
                                </span>
                            </div>
                            <div class="error-row">
                                <span>False Negative Rate</span>
                                <span class="@((_biasAnalysis.GenderAnalysis?.Male.FalseNegativeRate ?? 0) > 10 ? "danger" : "")">
                                    @(_biasAnalysis.GenderAnalysis?.Male.FalseNegativeRate.ToString("F1"))%
                                </span>
                                <span class="@((_biasAnalysis.GenderAnalysis?.Female.FalseNegativeRate ?? 0) > 10 ? "danger" : "")">
                                    @(_biasAnalysis.GenderAnalysis?.Female.FalseNegativeRate.ToString("F1"))%
                                </span>
                            </div>
                        </div>
                        <p class="error-note">
                            <strong>Note:</strong> False negatives (predicting low risk when high) are more critical in healthcare.
                        </p>
                    </div>

                    <!-- Fairness Score Card -->
                    <div class="analysis-card fairness-card">
                        <h4>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Overall Fairness Score
                        </h4>
                        <div class="fairness-display">
                            <div class="fairness-gauge">
                                <svg viewBox="0 0 100 50" class="gauge-svg">
                                    <path d="M 10 45 A 35 35 0 0 1 90 45" fill="none" stroke="#e2e8f0" stroke-width="8" stroke-linecap="round"/>
                                    <path d="M 10 45 A 35 35 0 0 1 90 45" fill="none" stroke="@GetFairnessColor(_biasAnalysis.FairnessScore)" 
                                          stroke-width="8" stroke-linecap="round"
                                          stroke-dasharray="@((_biasAnalysis.FairnessScore / 100) * 110) 110"/>
                                </svg>
                                <div class="gauge-value">@_biasAnalysis.FairnessScore.ToString("F0")</div>
                            </div>
                            <div class="fairness-rating @_biasAnalysis.FairnessRating.ToLower()">
                                @_biasAnalysis.FairnessRating
                            </div>
                        </div>
                        <div class="analysis-meta">
                            <span>Records analyzed: @_biasAnalysis.TotalRecords</span>
                            <span>Analyzed: @_biasAnalysis.AnalysisDate?.ToString("MMM dd, yyyy HH:mm")</span>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="no-analysis">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5">
                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <p>No bias analysis available. Upload CSV data to analyze model fairness across demographic groups.</p>
                </div>
            }
        </div>

        @* Bias Analysis Modal *@
        @if (_showBiasAnalysisModal)
        {
            <div class="modal-overlay" @onclick="CloseBiasAnalysisModal">
                <div class="modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h2>Analyze Bias & Fairness</h2>
                        <button class="modal-close" @onclick="CloseBiasAnalysisModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        @if (_isAnalyzing)
                        {
                            <div class="training-progress">
                                <div class="progress-spinner"></div>
                                <p class="progress-text">Analyzing data for bias metrics...</p>
                            </div>
                        }
                        else if (_analysisComplete)
                        {
                            <div class="training-success">
                                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                <h3>Analysis Complete!</h3>
                                <p>Bias and fairness metrics have been calculated for your dataset.</p>
                                <button class="btn btn-primary" @onclick="CloseBiasAnalysisModal">View Results</button>
                            </div>
                        }
                        else
                        {
                            <div class="upload-section">
                                <div class="upload-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
                                    </svg>
                                </div>
                                <p>Upload a CSV file to analyze model predictions for bias</p>
                                <p class="hint">Uses the same format as training data</p>
                                
                                @if (!string.IsNullOrEmpty(_analysisError))
                                {
                                    <div class="alert-error">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <line x1="12" y1="8" x2="12" y2="12"/>
                                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                                        </svg>
                                        @_analysisError
                                    </div>
                                }
                                
                                <button class="btn btn-primary btn-large" @onclick="SelectCsvForAnalysis">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                    </svg>
                                    Select CSV File
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @* Training Modal *@
        @if (_showTrainingModal)
        {
            <div class="modal-overlay" @onclick="CloseTrainingModal">
                <div class="modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h2>Train AI Model</h2>
                        <button class="modal-close" @onclick="CloseTrainingModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        @if (_trainingCompleted)
                        {
                            <div class="training-success">
                                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                <h3>Training Completed!</h3>
                                <p>@_trainingMessage</p>
                                @if (_trainingAccuracy.HasValue)
                                {
                                    <div class="accuracy-display">
                                        <span class="accuracy-label">Model Accuracy</span>
                                        <span class="accuracy-value">@(_trainingAccuracy.Value.ToString("P1"))</span>
                                    </div>
                                }
                                @if (_trainingDuration.HasValue)
                                {
                                    <p class="duration">Training completed in @(_trainingDuration.Value.TotalSeconds.ToString("F1"))s</p>
                                }
                                <button class="btn btn-primary" @onclick="CloseAndRefresh">Done</button>
                            </div>
                        }
                        else if (_isTraining)
                        {
                            <div class="training-progress">
                                <div class="progress-spinner"></div>
                                <p class="progress-text">@_trainingProgress</p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: @(_progressPercent)%"></div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="upload-section">
                                <div class="upload-icon">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                </div>
                                <p>Select a CSV file to train the AI model</p>
                                <p class="hint">Minimum 10 records required for training</p>
                                
                                @if (!string.IsNullOrEmpty(_uploadError))
                                {
                                    <div class="alert-error">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <line x1="12" y1="8" x2="12" y2="12"/>
                                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                                        </svg>
                                        @_uploadError
                                    </div>
                                }
                                
                                <button class="btn btn-primary btn-large" @onclick="SelectCsvFile">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                    </svg>
                                    Select CSV File
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @* Info Modal *@
        @if (_showInfoModal)
        {
            <div class="modal-overlay" @onclick="@(() => _showInfoModal = false)">
                <div class="modal-content modal-large" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h2>How the AI Model Works</h2>
                        <button class="modal-close" @onclick="@(() => _showInfoModal = false)">&times;</button>
                    </div>
                    <div class="modal-body info-modal-body">
                        <div class="info-section">
                            <h4>?? Machine Learning Algorithm</h4>
                            <p>The triage model uses <strong>ML.NET's SDCA Maximum Entropy classifier</strong>, a multi-class classification algorithm optimized for healthcare triage scenarios.</p>
                        </div>
                        
                        <div class="info-section">
                            <h4>?? Features Used for Prediction</h4>
                            <ul>
                                <li>Patient age and gender</li>
                                <li>Symptom count and severity score</li>
                                <li>Vital signs (BP, heart rate, temperature)</li>
                                <li>Pre-existing conditions (diabetes, heart disease, hypertension)</li>
                            </ul>
                        </div>
                        
                        <div class="info-section">
                            <h4>?? Prediction Categories</h4>
                            <div class="triage-levels">
                                <div class="level critical">
                                    <strong>Critical/Emergency</strong>
                                    <span>Immediate attention required</span>
                                </div>
                                <div class="level high">
                                    <strong>High/Urgent</strong>
                                    <span>See within 15 minutes</span>
                                </div>
                                <div class="level medium">
                                    <strong>Medium/Standard</strong>
                                    <span>Can wait up to 1 hour</span>
                                </div>
                                <div class="level low">
                                    <strong>Low/Non-Urgent</strong>
                                    <span>Safe to wait longer</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h4>? Fallback System</h4>
                            <p>When no trained model is available, the system uses a comprehensive <strong>rule-based algorithm</strong> that evaluates vital signs and symptoms to determine triage priority.</p>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private ModelInfo _modelInfo = new();
    private bool _showTrainingModal = false;
    private bool _showInfoModal = false;
    private bool _isTraining = false;
    private bool _trainingCompleted = false;
    private string _trainingProgress = "";
    private string _trainingMessage = "";
    private double? _trainingAccuracy;
    private TimeSpan? _trainingDuration;
    private string? _uploadError;
    private int _progressPercent = 0;
    
    // Bias analysis state
    private BiasAnalysisResult? _biasAnalysis;
    private bool _showBiasAnalysisModal = false;
    private bool _isAnalyzing = false;
    private bool _analysisComplete = false;
    private string? _analysisError;

    protected override void OnInitialized()
    {
        RefreshModelInfo();
        _biasAnalysis = ModelTrainingService.GetCachedBiasAnalysis();
    }

    private void RefreshModelInfo()
    {
        _modelInfo = ModelTrainingService.GetModelInfo();
    }

    private void HandleTrainModel()
    {
        _showTrainingModal = true;
        _trainingCompleted = false;
        _isTraining = false;
        _trainingProgress = "";
        _trainingMessage = "";
        _trainingAccuracy = null;
        _trainingDuration = null;
        _uploadError = null;
        _progressPercent = 0;
    }

    private void CloseTrainingModal()
    {
        _showTrainingModal = false;
    }

    private void CloseAndRefresh()
    {
        _showTrainingModal = false;
        RefreshModelInfo();
        _biasAnalysis = ModelTrainingService.GetCachedBiasAnalysis();
    }
    
    // Bias Analysis Methods
    private void OpenBiasAnalysisModal()
    {
        _showBiasAnalysisModal = true;
        _isAnalyzing = false;
        _analysisComplete = false;
        _analysisError = null;
    }
    
    private void CloseBiasAnalysisModal()
    {
        _showBiasAnalysisModal = false;
    }
    
    private async Task SelectCsvForAnalysis()
    {
        try
        {
            _analysisError = null;

            var customFileType = new FilePickerFileType(
                new Dictionary<DevicePlatform, IEnumerable<string>>
                {
                    { DevicePlatform.WinUI, new[] { ".csv" } },
                    { DevicePlatform.Android, new[] { "text/csv", "text/comma-separated-values", "application/csv", "*/*" } },
                    { DevicePlatform.iOS, new[] { "public.comma-separated-values-text" } },
                    { DevicePlatform.MacCatalyst, new[] { "public.comma-separated-values-text" } }
                });

            var options = new PickOptions
            {
                PickerTitle = "Select CSV file for bias analysis",
                FileTypes = customFileType
            };

            var result = await FilePicker.Default.PickAsync(options);

            if (result != null)
            {
                await AnalyzeBiasFromFile(result);
            }
        }
        catch (Exception ex)
        {
            _analysisError = $"Error selecting file: {ex.Message}";
        }
    }
    
    private async Task AnalyzeBiasFromFile(FileResult file)
    {
        _isAnalyzing = true;
        StateHasChanged();

        try
        {
            using var stream = await file.OpenReadAsync();
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            _biasAnalysis = await ModelTrainingService.AnalyzeBiasAsync(memoryStream);
            
            if (_biasAnalysis.IsAvailable)
            {
                _analysisComplete = true;
            }
            else
            {
                _analysisError = "Could not analyze the file. Please ensure it has at least 10 valid records.";
                _isAnalyzing = false;
            }
        }
        catch (Exception ex)
        {
            _analysisError = $"Analysis failed: {ex.Message}";
            _isAnalyzing = false;
        }

        StateHasChanged();
    }
    
    private string GetFairnessColor(double score)
    {
        return score switch
        {
            >= 90 => "#22c55e",
            >= 80 => "#84cc16",
            >= 70 => "#f59e0b",
            >= 60 => "#f97316",
            _ => "#ef4444"
        };
    }

    private async Task SelectCsvFile()
    {
        try
        {
            _uploadError = null;

            var customFileType = new FilePickerFileType(
                new Dictionary<DevicePlatform, IEnumerable<string>>
                {
                    { DevicePlatform.WinUI, new[] { ".csv" } },
                    { DevicePlatform.Android, new[] { "text/csv", "text/comma-separated-values", "application/csv", "*/*" } },
                    { DevicePlatform.iOS, new[] { "public.comma-separated-values-text" } },
                    { DevicePlatform.MacCatalyst, new[] { "public.comma-separated-values-text" } }
                });

            var options = new PickOptions
            {
                PickerTitle = "Select CSV file for training",
                FileTypes = customFileType
            };

            var result = await FilePicker.Default.PickAsync(options);

            if (result != null)
            {
                await TrainModelFromFile(result);
            }
        }
        catch (Exception ex)
        {
            _uploadError = $"Error selecting file: {ex.Message}";
        }
    }

    private async Task TrainModelFromFile(FileResult file)
    {
        _isTraining = true;
        _trainingProgress = "Reading file...";
        _progressPercent = 10;
        StateHasChanged();

        try
        {
            using var stream = await file.OpenReadAsync();
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            var trainingResult = await ModelTrainingService.TrainFromCsvAsync(
                memoryStream,
                progress =>
                {
                    _trainingProgress = progress;
                    _progressPercent = progress switch
                    {
                        var p when p.Contains("Loading") => 20,
                        var p when p.Contains("Transforming") => 35,
                        var p when p.Contains("Processing") => 50,
                        var p when p.Contains("Building") => 60,
                        var p when p.Contains("Training") => 75,
                        var p when p.Contains("Evaluating") => 85,
                        var p when p.Contains("Saving") => 95,
                        var p when p.Contains("completed") => 100,
                        _ => _progressPercent
                    };
                    InvokeAsync(StateHasChanged);
                });

            if (trainingResult.Success)
            {
                _trainingCompleted = true;
                _trainingMessage = trainingResult.Message;
                _trainingAccuracy = trainingResult.Accuracy;
                _trainingDuration = trainingResult.TrainingDuration;
                _progressPercent = 100;
            }
            else
            {
                _uploadError = trainingResult.Message;
                _isTraining = false;
            }
        }
        catch (Exception ex)
        {
            _uploadError = $"Training failed: {ex.Message}";
            _isTraining = false;
        }

        StateHasChanged();
    }

    private async Task DownloadSampleCsv()
    {
        var sampleCsv = @"Patient_ID,Age,Gender,Symptoms,Blood_Pressure,Heart_Rate,Temperature,Pre_Existing_Conditions,Risk_Level
P001,45,Male,""Chest pain, Shortness of breath"",150/95,110,37.2,Hypertension,High
P002,32,Female,""Fever, Headache"",120/80,85,38.5,None,Medium
P003,67,Male,""Severe chest pain, Difficulty breathing"",180/110,130,37.8,""Diabetes, Heart disease"",Critical
P004,28,Female,""Mild headache"",115/75,72,36.8,None,Low
P005,55,Male,""Dizziness, Nausea"",140/90,95,37.0,Hypertension,Medium
P006,72,Female,""Unconscious, Low breathing"",90/60,55,35.5,""Heart disease, Diabetes"",Critical
P007,40,Male,""Fever, Cough"",125/82,88,39.0,None,Medium
P008,35,Female,""Abdominal pain"",118/78,76,37.1,None,Low
P009,60,Male,""Chest tightness, Arm pain"",165/100,105,37.3,""Diabetes, Hypertension"",High
P010,50,Female,""High fever, Severe body aches"",130/85,98,40.2,None,High
P011,25,Male,""Minor cut, Bleeding"",120/80,75,36.9,None,Low
P012,78,Female,""Confusion, Weakness"",170/105,62,36.5,""Hypertension, Heart disease"",Critical
P013,42,Male,""Back pain, Limited mobility"",128/84,80,37.0,None,Medium
P014,38,Female,""Allergic reaction, Swelling"",135/88,92,37.4,Allergies,High
P015,65,Male,""Persistent cough, Fatigue"",145/92,86,37.8,""Diabetes, Hypertension"",Medium";

        try
        {
            var fileName = $"sample_triage_data.csv";
            var filePath = Path.Combine(FileSystem.CacheDirectory, fileName);
            await File.WriteAllTextAsync(filePath, sampleCsv);

            await Share.Default.RequestAsync(new ShareFileRequest
            {
                Title = "Sample Triage CSV",
                File = new ShareFile(filePath)
            });
        }
        catch (Exception ex)
        {
            _uploadError = $"Could not share file: {ex.Message}";
            StateHasChanged();
        }
    }
}

<style>
    .ai-model-page {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 16px;
    }

    .page-header {
        margin-bottom: 24px;
    }

    .page-header h1 {
        font-size: 24px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
    }

    .page-header p {
        color: #64748b;
        margin: 0;
        font-size: 14px;
    }

    /* Access Denied */
    .access-denied {
        text-align: center;
        padding: 60px 24px;
    }

    .access-denied h2 {
        margin: 16px 0 8px;
        color: #1e293b;
    }

    .access-denied p {
        color: #64748b;
        margin-bottom: 24px;
    }

    /* Model Status Card */
    .model-status-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .status-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }

    .status-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .status-icon.active {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
    }

    .status-icon.inactive {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .status-info h3 {
        margin: 0 0 4px 0;
        font-size: 16px;
        color: #1e293b;
    }

    .status-badge {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 20px;
    }

    .badge-active {
        background: rgba(34, 197, 94, 0.1);
        color: #15803d;
    }

    .badge-warning {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }

    .model-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-top: 16px;
        border-top: 1px solid #e2e8f0;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .detail-label {
        color: #64748b;
        font-size: 14px;
    }

    .detail-value {
        color: #1e293b;
        font-weight: 500;
        font-size: 14px;
    }

    .detail-value.path {
        font-size: 11px;
        font-family: monospace;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .no-model-info {
        padding-top: 16px;
        border-top: 1px solid #e2e8f0;
    }

    .no-model-info p {
        color: #64748b;
        font-size: 14px;
        margin: 0 0 8px 0;
    }

    .no-model-info .hint {
        font-size: 13px;
        color: #94a3b8;
    }

    /* Action Grid */
    .action-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .action-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .card-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
    }

    .card-icon.train {
        background: rgba(13, 148, 136, 0.1);
        color: #0d9488;
    }

    .card-icon.sample {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
    }

    .card-icon.info {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .action-card h3 {
        font-size: 15px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 8px 0;
    }

    .action-card p {
        font-size: 13px;
        color: #64748b;
        margin: 0 0 16px 0;
        line-height: 1.5;
    }

    /* CSV Info Section */
    .csv-info-section {
        background: #ffffff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .csv-info-section h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 16px 0;
    }

    .csv-table-container {
        overflow-x: auto;
    }

    .csv-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .csv-table th {
        background: #f8fafc;
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        color: #475569;
        border-bottom: 2px solid #e2e8f0;
    }

    .csv-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f1f5f9;
        color: #64748b;
    }

    .csv-table code {
        background: #f1f5f9;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        color: #0d9488;
    }

    .format-note {
        margin-top: 16px;
        padding: 12px 16px;
        background: #f0fdf4;
        border-radius: 8px;
        font-size: 13px;
        color: #166534;
    }

    .format-note strong {
        color: #15803d;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-primary {
        background: #0d9488;
        color: #ffffff;
    }

    .btn-primary:hover {
        background: #0f766e;
    }

    .btn-outline {
        background: transparent;
        border: 1.5px solid #e2e8f0;
        color: #475569;
    }

    .btn-outline:hover {
        border-color: #0d9488;
        color: #0d9488;
    }

    .btn-large {
        padding: 14px 24px;
        font-size: 15px;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-content {
        background: #ffffff;
        border-radius: 16px;
        width: 100%;
        max-width: 420px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-large {
        max-width: 560px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 18px;
        color: #1e293b;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #64748b;
        cursor: pointer;
    }

    .modal-body {
        padding: 24px 20px;
    }

    /* Upload Section */
    .upload-section {
        text-align: center;
    }

    .upload-icon {
        color: #94a3b8;
        margin-bottom: 16px;
    }

    .upload-section p {
        color: #64748b;
        margin: 0 0 8px 0;
    }

    .upload-section .hint {
        font-size: 13px;
        color: #94a3b8;
        margin-bottom: 20px;
    }

    .alert-error {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: #fef2f2;
        border-radius: 10px;
        color: #dc2626;
        font-size: 14px;
        margin-bottom: 16px;
    }

    /* Training Progress */
    .training-progress {
        text-align: center;
        padding: 20px 0;
    }

    .progress-spinner {
        width: 48px;
        height: 48px;
        border: 3px solid #e2e8f0;
        border-top-color: #0d9488;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .progress-text {
        color: #64748b;
        margin-bottom: 16px;
    }

    .progress-bar {
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: #0d9488;
        transition: width 0.3s ease;
    }

    /* Training Success */
    .training-success {
        text-align: center;
    }

    .training-success h3 {
        color: #15803d;
        margin: 16px 0 8px;
    }

    .training-success p {
        color: #64748b;
        font-size: 14px;
        margin-bottom: 16px;
    }

    .accuracy-display {
        background: #f0fdf4;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .accuracy-label {
        display: block;
        font-size: 13px;
        color: #64748b;
        margin-bottom: 4px;
    }

    .accuracy-value {
        font-size: 28px;
        font-weight: 700;
        color: #15803d;
    }

    .duration {
        font-size: 13px;
        color: #94a3b8;
    }

    /* Info Modal */
    .info-modal-body {
        padding: 20px;
    }

    .info-section {
        margin-bottom: 20px;
    }

    .info-section h4 {
        font-size: 15px;
        color: #1e293b;
        margin: 0 0 8px 0;
    }

    .info-section p {
        font-size: 14px;
        color: #64748b;
        line-height: 1.6;
        margin: 0;
    }

    .info-section ul {
        margin: 0;
        padding-left: 20px;
        color: #64748b;
        font-size: 14px;
    }

    .info-section li {
        margin-bottom: 4px;
    }

    .triage-levels {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .triage-levels .level {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 13px;
    }

    .level.critical { background: rgba(220, 38, 38, 0.1); }
    .level.critical strong { color: #dc2626; }

    .level.high { background: rgba(245, 158, 11, 0.1); }
    .level.high strong { color: #d97706; }

    .level.medium { background: rgba(59, 130, 246, 0.1); }
    .level.medium strong { color: #2563eb; }

    .level.low { background: rgba(34, 197, 94, 0.1); }
    .level.low strong { color: #16a34a; }

    .level span {
        color: #64748b;
    }

    /* Bias Analysis Section */
    .bias-analysis-section {
        background: #ffffff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .section-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 4px 0;
    }

    .section-header p {
        font-size: 13px;
        color: #64748b;
        margin: 0;
    }

    .analysis-results {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .analysis-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #e2e8f0;
    }

    .analysis-card.wide {
        grid-column: span 2;
    }

    .analysis-card h4 {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 16px 0;
    }

    .analysis-card h4 svg {
        color: #0d9488;
    }

    /* Gender Metrics */
    .gender-metrics {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 12px;
    }

    .gender-item {
        display: grid;
        grid-template-columns: 32px 1fr 100px;
        align-items: center;
        gap: 12px;
    }

    .gender-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
    }

    .gender-item.male .gender-icon {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .gender-item.female .gender-icon {
        background: rgba(236, 72, 153, 0.1);
        color: #ec4899;
    }

    .gender-info {
        display: flex;
        flex-direction: column;
    }

    .gender-label {
        font-size: 13px;
        color: #64748b;
    }

    .gender-value {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
    }

    .sample-count {
        font-size: 11px;
        color: #94a3b8;
    }

    .accuracy-bar-mini {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .accuracy-bar-mini .accuracy-fill {
        height: 100%;
        background: linear-gradient(90deg, #0d9488, #22c55e);
        border-radius: 4px;
    }

    .disparity-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 13px;
        color: #64748b;
    }

    .disparity-info.low {
        background: rgba(34, 197, 94, 0.1);
    }

    .disparity-info.high {
        background: rgba(245, 158, 11, 0.1);
    }

    .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .status-badge.good {
        background: #22c55e;
        color: white;
    }

    .status-badge.warning {
        background: #f59e0b;
        color: white;
    }

    /* Age Chart */
    .age-chart {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
    }

    .age-group-bar {
        display: grid;
        grid-template-columns: 50px 1fr 50px;
        align-items: center;
        gap: 10px;
    }

    .bar-label {
        font-size: 12px;
        font-weight: 500;
        color: #475569;
        text-align: right;
    }

    .stacked-bar {
        height: 24px;
        display: flex;
        border-radius: 4px;
        overflow: hidden;
        background: #e2e8f0;
    }

    .bar-segment {
        height: 100%;
        transition: width 0.3s ease;
    }

    .bar-segment.low { background: #22c55e; }
    .bar-segment.medium { background: #3b82f6; }
    .bar-segment.high { background: #f59e0b; }
    .bar-segment.critical { background: #dc2626; }

    .bar-count {
        font-size: 11px;
        color: #94a3b8;
    }

    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 16px;
        padding-top: 8px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #64748b;
    }

    .legend-item .dot {
        width: 10px;
        height: 10px;
        border-radius: 2px;
    }

    .legend-item .dot.low { background: #22c55e; }
    .legend-item .dot.medium { background: #3b82f6; }
    .legend-item .dot.high { background: #f59e0b; }
    .legend-item .dot.critical { background: #dc2626; }

    /* Error Rates Table */
    .error-rates-table {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 12px;
    }

    .error-row {
        display: grid;
        grid-template-columns: 1fr 60px 60px;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 13px;
    }

    .error-row.header {
        background: #e2e8f0;
        font-weight: 600;
        color: #475569;
    }

    .error-row:not(.header) {
        background: #f8fafc;
    }

    .error-row span {
        text-align: center;
    }

    .error-row span:first-child {
        text-align: left;
    }

    .error-row .warning {
        color: #f59e0b;
        font-weight: 600;
    }

    .error-row .danger {
        color: #dc2626;
        font-weight: 600;
    }

    .error-note {
        font-size: 11px;
        color: #94a3b8;
        margin: 0;
        padding: 8px;
        background: rgba(245, 158, 11, 0.1);
        border-radius: 6px;
    }

    /* Fairness Card */
    .fairness-card {
        text-align: center;
    }

    .fairness-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }

    .fairness-gauge {
        position: relative;
        width: 120px;
        height: 70px;
    }

    .gauge-svg {
        width: 100%;
        height: 100%;
    }

    .gauge-value {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
    }

    .fairness-rating {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
    }

    .fairness-rating.excellent { background: rgba(34, 197, 94, 0.1); color: #15803d; }
    .fairness-rating.good { background: rgba(132, 204, 22, 0.1); color: #4d7c0f; }
    .fairness-rating.fair { background: rgba(245, 158, 11, 0.1); color: #d97706; }
    .fairness-rating.needs\ improvement { background: rgba(249, 115, 22, 0.1); color: #c2410c; }
    .fairness-rating.poor { background: rgba(239, 68, 68, 0.1); color: #dc2626; }

    .analysis-meta {
        display: flex;
        justify-content: center;
        gap: 16px;
        font-size: 11px;
        color: #94a3b8;
    }

    .no-analysis {
        text-align: center;
        padding: 40px 20px;
        color: #94a3b8;
    }

    .no-analysis svg {
        margin-bottom: 12px;
    }

    .no-analysis p {
        margin: 0;
        font-size: 13px;
        max-width: 300px;
        margin: 0 auto;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .action-grid {
            grid-template-columns: 1fr;
        }

        .detail-value.path {
            max-width: 150px;
        }
        
        .analysis-results {
            grid-template-columns: 1fr;
        }
        
        .analysis-card.wide {
            grid-column: span 1;
        }
        
        .section-header {
            flex-direction: column;
        }
        
        .gender-item {
            grid-template-columns: 32px 1fr;
        }
        
        .accuracy-bar-mini {
            display: none;
        }
    }
</style>
