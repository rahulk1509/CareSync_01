@page "/doctors"
@inject HospitalTriageAI.Services.IDoctorService DoctorService
@inject HospitalTriageAI.Services.IAuthService AuthService
@inject NavigationManager Navigation

@if (!AuthService.IsAdmin)
{
    <div class="access-denied">
        <h2>Access Denied</h2>
        <p>You must be logged in as an administrator to access this page.</p>
        <a href="/login" class="btn btn-primary">Login as Admin</a>
    </div>
}
else
{
<div class="doctors-page">
    <div class="page-header">
        <div>
            <h1>Doctor Availability Management</h1>
            <p>Manage doctor schedules and patient assignments</p>
        </div>
        <a href="/admin-dashboard" class="btn btn-outline">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <!-- Stats Summary -->
    <section class="stats-row">
        <div class="mini-stat">
            <span class="mini-value">@_stats.TotalDoctors</span>
            <span class="mini-label">Total Doctors</span>
        </div>
        <div class="mini-stat available">
            <span class="mini-value">@_stats.AvailableDoctors</span>
            <span class="mini-label">Available</span>
        </div>
        <div class="mini-stat">
            <span class="mini-value">@_stats.TotalCapacity</span>
            <span class="mini-label">Total Capacity</span>
        </div>
        <div class="mini-stat">
            <span class="mini-value">@(_stats.TotalCapacity - _stats.TotalPatientLoad)</span>
            <span class="mini-label">Open Slots</span>
        </div>
    </section>

    <!-- Department Filter -->
    <section class="filter-bar">
        <div class="filter-group">
            <label>Filter by Department:</label>
            <select @bind="_selectedDepartment" class="form-input">
                <option value="">All Departments</option>
                @foreach (var dept in Enum.GetValues<Department>())
                {
                    <option value="@dept">@dept</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Status:</label>
            <select @bind="_selectedStatus" class="form-input">
                <option value="">All</option>
                <option value="available">Available Only</option>
                <option value="unavailable">Unavailable Only</option>
            </select>
        </div>
    </section>

    <!-- Doctor Cards -->
    <section class="doctors-grid">
        @foreach (var doctor in FilteredDoctors)
        {
            <div class="doctor-card @(doctor.IsAvailable ? "available" : "unavailable")">
                <div class="doctor-header">
                    <div class="doctor-avatar">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="doctor-title">
                        <h3>@doctor.Name</h3>
                        <span class="specialization">@doctor.Specialization</span>
                    </div>
                    <span class="availability-badge @(doctor.IsAvailable ? "available" : "unavailable")">
                        @(doctor.IsAvailable ? "Available" : "Unavailable")
                    </span>
                </div>

                <div class="doctor-details">
                    <div class="detail-row">
                        <span class="detail-label">Department</span>
                        <span class="detail-value department-badge">@doctor.Department</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Current Workload</span>
                        <span class="detail-value">@doctor.CurrentPatientCount patients</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Max Capacity</span>
                        <span class="detail-value">@doctor.MaxPatientCapacity patients</span>
                    </div>
                </div>

                <!-- Capacity Bar -->
                <div class="capacity-section">
                    <div class="capacity-header">
                        <span>Capacity</span>
                        <span>@doctor.CurrentPatientCount / @doctor.MaxPatientCapacity</span>
                    </div>
                    <div class="capacity-bar">
                        <div class="capacity-fill @GetCapacityClass(doctor)" 
                             style="width: @GetCapacityPercentage(doctor)%"></div>
                    </div>
                    <span class="capacity-status @(doctor.CanAcceptPatients ? "can-accept" : "at-capacity")">
                        @(doctor.CanAcceptPatients ? $"{doctor.MaxPatientCapacity - doctor.CurrentPatientCount} slots available" : "At capacity")
                    </span>
                </div>

                <div class="doctor-actions">
                    <button class="btn @(doctor.IsAvailable ? "btn-outline-danger" : "btn-primary") w-full"
                            @onclick="() => ToggleAvailability(doctor.Id)">
                        @if (doctor.IsAvailable)
                        {
                            <span>Mark as Unavailable</span>
                        }
                        else
                        {
                            <span>Mark as Available</span>
                        }
                    </button>
                </div>
            </div>
        }
    </section>

    @if (!FilteredDoctors.Any())
    {
        <div class="empty-state">
            <p>No doctors match the selected filters.</p>
        </div>
    }
</div>
}

@code {
    private List<Doctor> _doctors = new();
    private DoctorStats _stats = new();
    private string _selectedDepartment = "";
    private string _selectedStatus = "";

    private IEnumerable<Doctor> FilteredDoctors => _doctors
        .Where(d => string.IsNullOrEmpty(_selectedDepartment) || d.Department.ToString() == _selectedDepartment)
        .Where(d => string.IsNullOrEmpty(_selectedStatus) || 
                    (_selectedStatus == "available" && d.IsAvailable) ||
                    (_selectedStatus == "unavailable" && !d.IsAvailable));

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _doctors = await DoctorService.GetAllDoctorsAsync();
        _stats = await DoctorService.GetStatsAsync();
    }

    private async Task ToggleAvailability(int doctorId)
    {
        await DoctorService.ToggleAvailabilityAsync(doctorId);
        await LoadData();
    }

    private int GetCapacityPercentage(Doctor doctor)
    {
        if (doctor.MaxPatientCapacity == 0) return 0;
        return (int)((double)doctor.CurrentPatientCount / doctor.MaxPatientCapacity * 100);
    }

    private string GetCapacityClass(Doctor doctor)
    {
        var percentage = GetCapacityPercentage(doctor);
        if (percentage >= 100) return "full";
        if (percentage >= 80) return "high";
        if (percentage >= 50) return "medium";
        return "low";
    }
}

<style>
    .access-denied {
        text-align: center;
        padding: var(--space-12);
    }

    .doctors-page {
        display: flex;
        flex-direction: column;
        gap: var(--space-6);
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .page-header h1 {
        margin-bottom: var(--space-1);
    }

    .page-header p {
        color: var(--gray-500);
        margin: 0;
    }

    /* Stats Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);
    }

    .mini-stat {
        background: var(--white);
        border: 2px solid var(--primary-border);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        text-align: center;
    }

    .mini-stat.available {
        border-color: #22C55E;
        background: rgba(34,197,94,0.05);
    }

    .mini-value {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
    }

    .mini-label {
        font-size: 0.8125rem;
        color: var(--gray-500);
    }

    /* Filter Bar */
    .filter-bar {
        display: flex;
        gap: var(--space-4);
        background: var(--white);
        border: 2px solid var(--primary-border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .filter-group label {
        font-weight: 500;
        color: var(--gray-600);
        white-space: nowrap;
    }

    .filter-group .form-input {
        min-width: 180px;
    }

    /* Doctor Cards Grid */
    .doctors-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-5);
    }

    .doctor-card {
        background: var(--white);
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        transition: all 0.2s ease;
    }

    .doctor-card.available {
        border-color: var(--primary-border);
    }

    .doctor-card.unavailable {
        border-color: var(--gray-300);
        background: var(--gray-50);
    }

    .doctor-header {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
        padding-bottom: var(--space-4);
        border-bottom: 1px solid var(--gray-200);
    }

    .doctor-avatar {
        width: 48px;
        height: 48px;
        background: var(--primary-light);
        color: var(--primary);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .doctor-card.unavailable .doctor-avatar {
        background: var(--gray-200);
        color: var(--gray-500);
    }

    .doctor-title {
        flex: 1;
    }

    .doctor-title h3 {
        margin: 0 0 var(--space-1) 0;
        font-size: 1rem;
    }

    .specialization {
        font-size: 0.8125rem;
        color: var(--gray-500);
    }

    .availability-badge {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .availability-badge.available {
        background: rgba(34,197,94,0.1);
        color: #22C55E;
    }

    .availability-badge.unavailable {
        background: rgba(220,38,38,0.1);
        color: #DC2626;
    }

    .doctor-details {
        margin-bottom: var(--space-4);
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: var(--space-2) 0;
        border-bottom: 1px solid var(--gray-100);
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        color: var(--gray-500);
        font-size: 0.8125rem;
    }

    .detail-value {
        font-weight: 500;
        font-size: 0.8125rem;
    }

    .department-badge {
        background: var(--primary-light);
        color: var(--primary);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
    }

    /* Capacity Section */
    .capacity-section {
        margin-bottom: var(--space-4);
    }

    .capacity-header {
        display: flex;
        justify-content: space-between;
        font-size: 0.8125rem;
        margin-bottom: var(--space-2);
    }

    .capacity-bar {
        height: 8px;
        background: var(--gray-200);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .capacity-fill {
        height: 100%;
        border-radius: var(--radius-full);
        transition: width 0.3s ease;
    }

    .capacity-fill.low { background: #22C55E; }
    .capacity-fill.medium { background: #F59E0B; }
    .capacity-fill.high { background: #EF4444; }
    .capacity-fill.full { background: #7C3AED; }

    .capacity-status {
        display: block;
        margin-top: var(--space-2);
        font-size: 0.75rem;
    }

    .capacity-status.can-accept {
        color: #22C55E;
    }

    .capacity-status.at-capacity {
        color: #EF4444;
    }

    .doctor-actions {
        margin-top: var(--space-4);
    }

    .w-full {
        width: 100%;
    }

    .btn-outline-danger {
        background: transparent;
        border: 1px solid #DC2626;
        color: #DC2626;
    }

    .btn-outline-danger:hover {
        background: rgba(220,38,38,0.1);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-8);
        color: var(--gray-500);
        background: var(--white);
        border: 2px solid var(--primary-border);
        border-radius: var(--radius-lg);
    }

    @@media (max-width: 1024px) {
        .doctors-grid { grid-template-columns: repeat(2, 1fr); }
        .stats-row { grid-template-columns: repeat(2, 1fr); }
    }

    @@media (max-width: 640px) {
        .doctors-grid { grid-template-columns: 1fr; }
        .filter-bar { flex-direction: column; }
        .page-header { flex-direction: column; gap: var(--space-4); }
    }
</style>
