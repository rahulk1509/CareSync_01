@page "/doctors"
@using HospitalTriageAI.Models.Enums
@inject HospitalTriageAI.Services.IDoctorService DoctorService
@inject HospitalTriageAI.Services.IAuthService AuthService
@inject NavigationManager Navigation

@if (!AuthService.IsAdmin)
{
    <div class="access-denied">
        <h2>Access Denied</h2>
        <p>You must be logged in as an administrator to access this page.</p>
        <a href="/login" class="btn btn-primary">Login as Admin</a>
    </div>
}
else
{
<div class="doctors-page">
    <div class="page-header">
        <div>
            <h1>Doctor Availability Management</h1>
            <p>Manage doctor schedules and patient assignments</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" @onclick="OpenAddDoctorModal">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Doctor
            </button>
            <a href="/admin-dashboard" class="btn btn-outline">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
                Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Stats Summary -->
    <section class="stats-row">
        <div class="mini-stat">
            <span class="mini-value">@_stats.TotalDoctors</span>
            <span class="mini-label">Total Doctors</span>
        </div>
        <div class="mini-stat available">
            <span class="mini-value">@_stats.AvailableDoctors</span>
            <span class="mini-label">Available</span>
        </div>
        <div class="mini-stat">
            <span class="mini-value">@_stats.TotalCapacity</span>
            <span class="mini-label">Total Capacity</span>
        </div>
        <div class="mini-stat">
            <span class="mini-value">@(_stats.TotalCapacity - _stats.TotalPatientLoad)</span>
            <span class="mini-label">Open Slots</span>
        </div>
    </section>

    <!-- Department Filter -->
    <section class="filter-bar">
        <div class="filter-group">
            <label>Filter by Department:</label>
            <select @bind="_selectedDepartment" class="form-input">
                <option value="">All Departments</option>
                @foreach (var dept in Enum.GetValues<Department>())
                {
                    <option value="@dept">@dept</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Status:</label>
            <select @bind="_selectedStatus" class="form-input">
                <option value="">All</option>
                <option value="available">Available Only</option>
                <option value="unavailable">Unavailable Only</option>
            </select>
        </div>
    </section>

    <!-- Doctor Cards -->
    <section class="doctors-grid">
        @foreach (var doctor in FilteredDoctors)
        {
            <div class="doctor-card @(doctor.IsAvailable ? "available" : "unavailable")">
                <div class="doctor-header">
                    <div class="doctor-avatar">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="doctor-title">
                        <h3>@doctor.Name</h3>
                        <span class="specialization">@doctor.Specialization</span>
                    </div>
                    <span class="availability-badge @(doctor.IsAvailable ? "available" : "unavailable")">
                        @(doctor.IsAvailable ? "Available" : "Unavailable")
                    </span>
                </div>

                <div class="doctor-details">
                    <div class="detail-row">
                        <span class="detail-label">Department</span>
                        <span class="detail-value department-badge">@doctor.Department</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Current Workload</span>
                        <span class="detail-value">@doctor.CurrentPatientCount patients</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Max Capacity</span>
                        <span class="detail-value">@doctor.MaxPatientCapacity patients</span>
                    </div>
                </div>

                <!-- Capacity Bar -->
                <div class="capacity-section">
                    <div class="capacity-header">
                        <span>Capacity</span>
                        <span>@doctor.CurrentPatientCount / @doctor.MaxPatientCapacity</span>
                    </div>
                    <div class="capacity-bar">
                        <div class="capacity-fill @GetCapacityClass(doctor)" 
                             style="width: @GetCapacityPercentage(doctor)%"></div>
                    </div>
                    <span class="capacity-status @(doctor.CanAcceptPatients ? "can-accept" : "at-capacity")">
                        @(doctor.CanAcceptPatients ? $"{doctor.MaxPatientCapacity - doctor.CurrentPatientCount} slots available" : "At capacity")
                    </span>
                </div>

                <div class="doctor-actions">
                    <button class="btn @(doctor.IsAvailable ? "btn-outline-danger" : "btn-primary") w-full"
                            @onclick="() => ToggleAvailability(doctor.Id)">
                        @if (doctor.IsAvailable)
                        {
                            <span>Mark as Unavailable</span>
                        }
                        else
                        {
                            <span>Mark as Available</span>
                        }
                    </button>
                </div>
            </div>
        }
    </section>

    @if (!FilteredDoctors.Any())
    {
        <div class="empty-state">
            <p>No doctors match the selected filters.</p>
        </div>
    }
</div>

<!-- Add/Edit Doctor Modal -->
@if (_showModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h2>@(_isEditing ? "Edit Doctor" : "Add New Doctor")</h2>
                <button class="modal-close" @onclick="CloseModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <EditForm Model="_formModel" OnValidSubmit="HandleValidSubmit" class="doctor-form">
                <DataAnnotationsValidator />
                
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-error">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        @_errorMessage
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(_successMessage))
                {
                    <div class="alert alert-success">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        @_successMessage
                    </div>
                }
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name">Full Name <span class="required">*</span></label>
                        <InputText id="name" class="form-input" @bind-Value="_formModel.Name" placeholder="Dr. John Smith" />
                        <ValidationMessage For="@(() => _formModel.Name)" />
                    </div>
                    
                    <div class="form-group">
                        <label for="specialization">Specialization <span class="required">*</span></label>
                        <InputText id="specialization" class="form-input" @bind-Value="_formModel.Specialization" placeholder="e.g., Cardiologist" />
                        <ValidationMessage For="@(() => _formModel.Specialization)" />
                    </div>
                    
                    <div class="form-group">
                        <label for="department">Department <span class="required">*</span></label>
                        <InputSelect id="department" class="form-input" @bind-Value="_formModel.Department">
                            <option value="">Select Department</option>
                            @foreach (var dept in Enum.GetValues<Department>())
                            {
                                <option value="@dept">@dept</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => _formModel.Department)" />
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email <span class="required">*</span></label>
                        <InputText id="email" type="email" class="form-input" @bind-Value="_formModel.Email" placeholder="doctor@hospital.com" />
                        <ValidationMessage For="@(() => _formModel.Email)" />
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <InputText id="phone" type="tel" class="form-input" @bind-Value="_formModel.Phone" placeholder="+1 (555) 123-4567" />
                        <ValidationMessage For="@(() => _formModel.Phone)" />
                    </div>
                    
                    <div class="form-group">
                        <label for="maxCapacity">Max Patient Capacity <span class="required">*</span></label>
                        <InputNumber id="maxCapacity" class="form-input" @bind-Value="_formModel.MaxPatientCapacity" min="1" max="50" />
                        <ValidationMessage For="@(() => _formModel.MaxPatientCapacity)" />
                    </div>
                    
                    <div class="form-group">
                        <label for="experience">Years of Experience</label>
                        <InputNumber id="experience" class="form-input" @bind-Value="_formModel.YearsOfExperience" min="0" max="60" />
                        <ValidationMessage For="@(() => _formModel.YearsOfExperience)" />
                    </div>
                    
                    <div class="form-group">
                        <label for="qualification">Qualification</label>
                        <InputText id="qualification" class="form-input" @bind-Value="_formModel.Qualification" placeholder="MBBS, MD, etc." />
                        <ValidationMessage For="@(() => _formModel.Qualification)" />
                    </div>
                    
                    <div class="form-group toggle-group">
                        <label class="toggle-label">
                            <InputCheckbox @bind-Value="_formModel.IsAvailable" class="toggle-input" />
                            <span class="toggle-switch"></span>
                            <span class="toggle-text">Available for Patients</span>
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" @onclick="CloseModal" disabled="@_isSubmitting">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <span class="spinner"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>@(_isEditing ? "Update Doctor" : "Add Doctor")</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}
}

@code {
    private List<Doctor> _doctors = new();
    private DoctorStats _stats = new();
    private string _selectedDepartment = "";
    private string _selectedStatus = "";
    
    // Modal state
    private bool _showModal = false;
    private bool _isEditing = false;
    private bool _isSubmitting = false;
    private string? _errorMessage;
    private string? _successMessage;
    private DoctorFormModel _formModel = new();

    private IEnumerable<Doctor> FilteredDoctors => _doctors
        .Where(d => string.IsNullOrEmpty(_selectedDepartment) || d.Department.ToString() == _selectedDepartment)
        .Where(d => string.IsNullOrEmpty(_selectedStatus) || 
                    (_selectedStatus == "available" && d.IsAvailable) ||
                    (_selectedStatus == "unavailable" && !d.IsAvailable));

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _doctors = await DoctorService.GetAllDoctorsAsync();
        _stats = await DoctorService.GetStatsAsync();
    }

    private async Task ToggleAvailability(int doctorId)
    {
        await DoctorService.ToggleAvailabilityAsync(doctorId);
        await LoadData();
    }
    
    private void OpenAddDoctorModal()
    {
        _formModel = new DoctorFormModel();
        _isEditing = false;
        _errorMessage = null;
        _successMessage = null;
        _showModal = true;
    }
    
    private void OpenEditDoctorModal(Doctor doctor)
    {
        _formModel = DoctorFormModel.FromDoctor(doctor);
        _isEditing = true;
        _errorMessage = null;
        _successMessage = null;
        _showModal = true;
    }
    
    private void CloseModal()
    {
        if (!_isSubmitting)
        {
            _showModal = false;
            _errorMessage = null;
            _successMessage = null;
        }
    }
    
    private async Task HandleValidSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;
        _successMessage = null;
        
        try
        {
            // Check if email already exists
            if (await DoctorService.EmailExistsAsync(_formModel.Email, _formModel.Id))
            {
                _errorMessage = "A doctor with this email already exists.";
                _isSubmitting = false;
                return;
            }
            
            var doctor = _formModel.ToDoctor();
            
            if (_isEditing)
            {
                await DoctorService.UpdateDoctorAsync(doctor);
                _successMessage = "Doctor updated successfully!";
            }
            else
            {
                await DoctorService.CreateDoctorAsync(doctor);
                _successMessage = "Doctor added successfully!";
            }
            
            // Reload data to refresh the list and stats
            await LoadData();
            
            // Close modal after short delay to show success message
            await Task.Delay(1000);
            _showModal = false;
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private int GetCapacityPercentage(Doctor doctor)
    {
        if (doctor.MaxPatientCapacity == 0) return 0;
        return (int)((double)doctor.CurrentPatientCount / doctor.MaxPatientCapacity * 100);
    }

    private string GetCapacityClass(Doctor doctor)
    {
        var percentage = GetCapacityPercentage(doctor);
        if (percentage >= 100) return "full";
        if (percentage >= 80) return "high";
        if (percentage >= 50) return "medium";
        return "low";
    }
}

<style>
    .access-denied {
        text-align: center;
        padding: var(--space-12);
    }

    .doctors-page {
        display: flex;
        flex-direction: column;
        gap: var(--space-6);
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .page-header h1 {
        margin-bottom: var(--space-1);
    }

    .page-header p {
        color: var(--gray-500);
        margin: 0;
    }

    /* Stats Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);
    }

    .mini-stat {
        background: var(--white);
        border: 2px solid var(--primary-border);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        text-align: center;
    }

    .mini-stat.available {
        border-color: #22C55E;
        background: rgba(34,197,94,0.05);
    }

    .mini-value {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
    }

    .mini-label {
        font-size: 0.8125rem;
        color: var(--gray-500);
    }

    /* Filter Bar */
    .filter-bar {
        display: flex;
        gap: var(--space-4);
        background: var(--white);
        border: 2px solid var(--primary-border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .filter-group label {
        font-weight: 500;
        color: var(--gray-600);
        white-space: nowrap;
    }

    .filter-group .form-input {
        min-width: 180px;
    }

    /* Doctor Cards Grid */
    .doctors-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-5);
    }

    .doctor-card {
        background: var(--white);
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        transition: all 0.2s ease;
    }

    .doctor-card.available {
        border-color: var(--primary-border);
    }

    .doctor-card.unavailable {
        border-color: var(--gray-300);
        background: var(--gray-50);
    }

    .doctor-header {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
        padding-bottom: var(--space-4);
        border-bottom: 1px solid var(--gray-200);
    }

    .doctor-avatar {
        width: 48px;
        height: 48px;
        background: var(--primary-light);
        color: var(--primary);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .doctor-card.unavailable .doctor-avatar {
        background: var(--gray-200);
        color: var(--gray-500);
    }

    .doctor-title {
        flex: 1;
    }

    .doctor-title h3 {
        margin: 0 0 var(--space-1) 0;
        font-size: 1rem;
    }

    .specialization {
        font-size: 0.8125rem;
        color: var(--gray-500);
    }

    .availability-badge {
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .availability-badge.available {
        background: rgba(34,197,94,0.1);
        color: #22C55E;
    }

    .availability-badge.unavailable {
        background: rgba(220,38,38,0.1);
        color: #DC2626;
    }

    .doctor-details {
        margin-bottom: var(--space-4);
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: var(--space-2) 0;
        border-bottom: 1px solid var(--gray-100);
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        color: var(--gray-500);
        font-size: 0.8125rem;
    }

    .detail-value {
        font-weight: 500;
        font-size: 0.8125rem;
    }

    .department-badge {
        background: var(--primary-light);
        color: var(--primary);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
    }

    /* Capacity Section */
    .capacity-section {
        margin-bottom: var(--space-4);
    }

    .capacity-header {
        display: flex;
        justify-content: space-between;
        font-size: 0.8125rem;
        margin-bottom: var(--space-2);
    }

    .capacity-bar {
        height: 8px;
        background: var(--gray-200);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .capacity-fill {
        height: 100%;
        border-radius: var(--radius-full);
        transition: width 0.3s ease;
    }

    .capacity-fill.low { background: #22C55E; }
    .capacity-fill.medium { background: #F59E0B; }
    .capacity-fill.high { background: #EF4444; }
    .capacity-fill.full { background: #7C3AED; }

    .capacity-status {
        display: block;
        margin-top: var(--space-2);
        font-size: 0.75rem;
    }

    .capacity-status.can-accept {
        color: #22C55E;
    }

    .capacity-status.at-capacity {
        color: #EF4444;
    }

    .doctor-actions {
        margin-top: var(--space-4);
    }

    .w-full {
        width: 100%;
    }

    .btn-outline-danger {
        background: transparent;
        border: 1px solid #DC2626;
        color: #DC2626;
    }

    .btn-outline-danger:hover {
        background: rgba(220,38,38,0.1);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-8);
        color: var(--gray-500);
        background: var(--white);
        border: 2px solid var(--primary-border);
        border-radius: var(--radius-lg);
    }

    /* Header Actions */
    .header-actions {
        display: flex;
        gap: var(--space-3);
        align-items: center;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: var(--space-4);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--white);
        border-radius: var(--radius-xl);
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: modalSlideIn 0.2s ease-out;
    }

    @@keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-5);
        border-bottom: 1px solid var(--gray-200);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .modal-close {
        background: transparent;
        border: none;
        padding: var(--space-2);
        cursor: pointer;
        color: var(--gray-500);
        border-radius: var(--radius-md);
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: var(--gray-100);
        color: var(--gray-700);
    }

    .doctor-form {
        padding: var(--space-5);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-4);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .form-group label {
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--gray-700);
    }

    .form-group .required {
        color: #DC2626;
    }

    .form-group .form-input {
        padding: var(--space-3);
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        font-size: 0.9375rem;
        transition: all 0.2s;
    }

    .form-group .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(78, 189, 184, 0.2);
    }

    .form-group .form-input::placeholder {
        color: var(--gray-400);
    }

    /* Toggle Switch */
    .toggle-group {
        grid-column: span 2;
        margin-top: var(--space-2);
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        cursor: pointer;
    }

    .toggle-input {
        display: none;
    }

    .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
        background: var(--gray-300);
        border-radius: var(--radius-full);
        transition: all 0.2s;
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background: var(--white);
        border-radius: 50%;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .toggle-input:checked + .toggle-switch {
        background: #22C55E;
    }

    .toggle-input:checked + .toggle-switch::after {
        transform: translateX(22px);
    }

    .toggle-text {
        font-weight: 500;
        color: var(--gray-700);
    }

    /* Alerts */
    .alert {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-4);
        font-size: 0.875rem;
    }

    .alert-error {
        background: rgba(220, 38, 38, 0.1);
        color: #DC2626;
        border: 1px solid rgba(220, 38, 38, 0.2);
    }

    .alert-success {
        background: rgba(34, 197, 94, 0.1);
        color: #16A34A;
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    /* Modal Footer */
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
        padding-top: var(--space-5);
        margin-top: var(--space-4);
        border-top: 1px solid var(--gray-200);
    }

    .modal-footer .btn {
        min-width: 120px;
    }

    /* Spinner */
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        margin-right: var(--space-2);
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    @@media (max-width: 1024px) {
        .doctors-grid { grid-template-columns: repeat(2, 1fr); }
        .stats-row { grid-template-columns: repeat(2, 1fr); }
    }

    @@media (max-width: 640px) {
        .doctors-grid { grid-template-columns: 1fr; }
        .filter-bar { flex-direction: column; }
        .page-header { flex-direction: column; gap: var(--space-4); }
        .header-actions { width: 100%; justify-content: space-between; }
        .form-grid { grid-template-columns: 1fr; }
        .toggle-group { grid-column: span 1; }
        .modal-content { margin: var(--space-4); }
    }
</style>
